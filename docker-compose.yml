version: '3.8'

services:
  headscale:
    image: 'headscale/headscale:latest'
    container_name: 'headscale'
    restart: 'unless-stopped'
    command: 'serve'
    volumes:
      - './data:/var/lib/headscale'
      - './configs/headscale:/etc/headscale'
    environment:
      TZ: 'America/Edmonton'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.headscale.rule=Host(`airos.one`)"
      - "traefik.http.routers.headscale.tls.certresolver=myresolver"
      - "traefik.http.routers.headscale.entrypoints=websecure"
      - "traefik.http.routers.headscale.tls=true"
      - "traefik.http.services.headscale.loadbalancer.server.port=8080"

  # -----------------------------
  # ðŸ”¥ SOVEREIGN UI - BACKEND
  # -----------------------------
  sovereign-backend:
    image: naude/sovereign-ui-backend:latest
    build: ./backend
    container_name: sovereign-ui-backend
    environment:
      - HEADSCALE_API_URL=http://headscale:8080
      - HEADSCALE_API_KEY=${HEADSCALE_API_KEY}
    volumes:
      - ./backend/.env:/root/.env
    networks:
      - default
    depends_on:
      - headscale

  # -----------------------------
  # ðŸ”¥ SOVEREIGN UI - FRONTEND
  # -----------------------------
  sovereign-frontend:
    image: naude/sovereign-ui-frontend:latest
    build: ./frontend
    container_name: sovereign-ui-frontend
    networks:
      - default
    depends_on:
      - sovereign-backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sovereign.rule=Host(`ui.airos.one`)"
      - "traefik.http.routers.sovereign.entrypoints=websecure"
      - "traefik.http.routers.sovereign.tls=true"
      - "traefik.http.routers.sovereign.tls.certresolver=myresolver"
      - "traefik.http.services.sovereign.loadbalancer.server.port=80"

  # -----------------------------
  # ðŸ”¥ TRAEFIK (unchanged)
  # -----------------------------
  traefik:
    image: "traefik:v3.3"
    container_name: "traefik"
    restart: 'unless-stopped'
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entryPoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=support@infocus.one"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

# ðŸ‘‡ one shared network
networks:
  default:
    driver: bridge

